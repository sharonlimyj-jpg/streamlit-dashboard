from datetime import datetime

import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import streamlit as st


def load_file(uploaded_file):
    """íŒŒì¼ì„ ë¡œë“œí•˜ê³  DataFrameì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜"""
    try:
        if uploaded_file is None:
            st.error("âŒ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return pd.DataFrame()

        # íŒŒì¼ ì´ë¦„ê³¼ í™•ì¥ì í™•ì¸
        file_name = uploaded_file.name
        st.write(f"ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼: **{file_name}**")

        # íŒŒì¼ í¬ì¸í„°ë¥¼ ì²˜ìŒìœ¼ë¡œ ì´ë™
        uploaded_file.seek(0)

        # Excel íŒŒì¼ ì²˜ë¦¬
        if file_name.endswith('.xlsx') or file_name.endswith('.xls'):
            df = pd.read_excel(uploaded_file, engine='openpyxl')
            st.success(f"âœ… Excel íŒŒì¼ ë¡œë“œ ì„±ê³µ: {len(df)}í–‰ Ã— {len(df.columns)}ì—´")

        # CSV íŒŒì¼ ì²˜ë¦¬
        elif file_name.endswith('.csv'):
            try:
                df = pd.read_csv(uploaded_file, encoding='utf-8-sig')
                st.success(f"âœ… CSV íŒŒì¼ ë¡œë“œ ì„±ê³µ: {len(df)}í–‰ Ã— {len(df.columns)}ì—´")
            except UnicodeDecodeError:
                uploaded_file.seek(0)
                df = pd.read_csv(uploaded_file, encoding='cp949')
                st.success(f"âœ… CSV íŒŒì¼ ë¡œë“œ ì„±ê³µ (cp949): {len(df)}í–‰ Ã— {len(df.columns)}ì—´")
        else:
            st.error(f"âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file_name}")
            return pd.DataFrame()

        # ë¡œë“œ ê²°ê³¼ í™•ì¸
        if df.empty:
            st.warning("âš ï¸ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
            return pd.DataFrame()

        # ë””ë²„ê¹…: ì»¬ëŸ¼ í™•ì¸
        st.write("ğŸ” **ë¡œë“œëœ ì»¬ëŸ¼ (ì²˜ìŒ 10ê°œ):**", df.columns.tolist()[:10])
        st.write("ğŸ” **ë°ì´í„° ìƒ˜í”Œ:**")
        st.dataframe(df.head(3))

        return df

    except Exception as e:
        st.error(f"âŒ íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        import traceback
        st.code(traceback.format_exc())
        return pd.DataFrame()


# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="2025 ì˜ì—… ì‹¤ì  ëŒ€ì‹œë³´ë“œ",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# íƒ€ì´í‹€
st.title("ğŸ“Š 2025ë…„ ì˜ì—… ì‹¤ì  ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
st.markdown("---")

# íŒŒì¼ ì—…ë¡œë“œ
st.markdown("### ğŸ“ ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ")
col_upload1, col_upload2 = st.columns(2)

with col_upload1:
    st.markdown("**íŒŒì¼ 1: ì˜ì—…ì±„ë„ ë¶„ì„ìš©**")
    uploaded_file = st.file_uploader(
        "ì˜ì—…ì±„ë„ ì¤‘ì‹¬ ë°ì´í„° (í•„ìˆ˜)",
        type=['xlsx', 'xls', 'csv'],
        key="file1"
    )

with col_upload2:
    st.markdown("**íŒŒì¼ 2: ì•½ì •ê¸°ê°„/ë¦¬ìŠ¤êµ¬ë¶„ ë¶„ì„ìš©**")
    uploaded_file2 = st.file_uploader(
        "ì•½ì •ê¸°ê°„/ë¦¬ìŠ¤êµ¬ë¶„ ì¤‘ì‹¬ ë°ì´í„° (ì„ íƒ)",
        type=['xlsx', 'xls', 'csv'],
        key="file2"
    )

st.markdown("---")

if uploaded_file is not None:
    # íŒŒì¼ ì½ê¸°
    try:
        if uploaded_file.name.endswith('.csv'):
            df = pd.read_csv(uploaded_file, encoding='utf-8-sig')
        else:
            df = pd.read_excel(uploaded_file)

        # ì»¬ëŸ¼ëª… ì •ë¦¬ (ê³µë°± ì œê±°)
        df.columns = df.columns.str.strip()

        # ë””ë²„ê¹…: ì‹¤ì œ ì»¬ëŸ¼ëª… í™•ì¸
        st.sidebar.info(f"íŒŒì¼ ì»¬ëŸ¼: {', '.join(df.columns[:5])}...")

        # í•„ìˆ˜ ì»¬ëŸ¼ ë§¤í•‘ (ìœ ì—°í•œ ì»¬ëŸ¼ëª… ì²˜ë¦¬)
        column_mapping = {}

        # ì—°ë„ ì»¬ëŸ¼ ì°¾ê¸°
        if 'ì—°ë„' in df.columns:
            column_mapping['ì—°ë„'] = 'ì—°ë„'
        else:
            st.error("'ì—°ë„' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            st.stop()

        # ì›” ì»¬ëŸ¼ ì°¾ê¸°
        if 'ì›”' in df.columns:
            column_mapping['ì›”'] = 'ì›”'
        else:
            st.error("'ì›”' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            st.stop()

        # ì˜ì—…ì±„ë„ ì»¬ëŸ¼ ì°¾ê¸°
        if 'ì˜ì—…ì±„ë„' in df.columns:
            column_mapping['ì˜ì—…ì±„ë„'] = 'ì˜ì—…ì±„ë„'
        else:
            st.error("'ì˜ì—…ì±„ë„' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            st.stop()

        # ì œí’ˆ ì»¬ëŸ¼ ì°¾ê¸°
        for col in df.columns:
            if 'ì œí’ˆê³„ì¸µêµ¬ì¡°1' in col or 'ì œí’ˆê³„ì¸µêµ¬ì¡° 1' in col:
                column_mapping['ì œí’ˆê³„ì¸µêµ¬ì¡°1'] = col
            if 'ì œí’ˆê³„ì¸µêµ¬ì¡°2' in col or 'ì œí’ˆê³„ì¸µêµ¬ì¡° 2' in col:
                column_mapping['ì œí’ˆê³„ì¸µêµ¬ì¡°2'] = col
            if 'ì œí’ˆëª…' in col:
                column_mapping['ì œí’ˆëª…'] = col

        # ë Œíƒˆ ê±´ìˆ˜ ì»¬ëŸ¼ ì°¾ê¸°
        for col in df.columns:
            if 'ì´ë Œíƒˆ' in col and 'ê±´' in col:
                column_mapping['ì´ë Œíƒˆ(ê±´)'] = col
            elif col == 'ë Œíƒˆ(ê±´)' or (('ë Œíƒˆ' in col or 'ì‹ ê·œ' in col) and 'ê±´' in col and 'ì´' not in col and 'ì¬' not in col):
                column_mapping['ë Œíƒˆ(ê±´)'] = col
            elif 'ì¬ë Œíƒˆ' in col and 'ê±´' in col:
                column_mapping['ì¬ë Œíƒˆ(ê±´)'] = col

        # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
        required_keys = ['ì—°ë„', 'ì›”', 'ì˜ì—…ì±„ë„', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1', 'ì œí’ˆê³„ì¸µêµ¬ì¡°2', 'ì œí’ˆëª…',
                         'ì´ë Œíƒˆ(ê±´)', 'ë Œíƒˆ(ê±´)', 'ì¬ë Œíƒˆ(ê±´)']

        missing_keys = [key for key in required_keys if key not in column_mapping]

        if missing_keys:
            st.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {', '.join(missing_keys)}")
            st.info(f"í˜„ì¬ íŒŒì¼ì˜ ì»¬ëŸ¼ëª…: {', '.join(df.columns.tolist())}")
            st.stop()

        # ì»¬ëŸ¼ëª… í‘œì¤€í™”
        df_renamed = df.rename(columns={v: k for k, v in column_mapping.items()})

        # ë°ì´í„° ì „ì²˜ë¦¬
        # ì—°ë„ ì²˜ë¦¬
        df_renamed['ì—°ë„'] = df_renamed['ì—°ë„'].astype(str)

        # ========== Section 1: í•µì‹¬ KPI ë©”íŠ¸ë¦­ ==========
        st.markdown("## ğŸ“ˆ í•µì‹¬ ì„±ê³¼ ì§€í‘œ (KPI)")

        # ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        if filtered_df.empty:
            st.warning("âš ï¸ ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            col1, col2, col3, col4 = st.columns(4)

            # ì´ ë Œíƒˆ ê±´ìˆ˜
            total_rental = filtered_df['ì´ë Œíƒˆ(ê±´)'].sum()
            prev_total_rental = prev_month_df['ì´ë Œíƒˆ(ê±´)'].sum() if not prev_month_df.empty else 0
            delta_total = total_rental - prev_total_rental
            delta_pct_total = (delta_total / prev_total_rental * 100) if prev_total_rental > 0 else 0

            with col1:
                st.metric(
                    label="ì´ ë Œíƒˆ ê±´ìˆ˜",
                    value=f"{int(total_rental):,}ê±´",
                    delta=f"{delta_pct_total:+.1f}% ({int(delta_total):+,}ê±´)" if prev_total_rental > 0 else "N/A"
                )

            # ì‹ ê·œ ë Œíƒˆ ê±´ìˆ˜
            new_rental = filtered_df['ë Œíƒˆ(ê±´)'].sum()
            prev_new_rental = prev_month_df['ë Œíƒˆ(ê±´)'].sum() if not prev_month_df.empty else 0
            delta_new = new_rental - prev_new_rental
            delta_pct_new = (delta_new / prev_new_rental * 100) if prev_new_rental > 0 else 0

            with col2:
                st.metric(
                    label="ì‹ ê·œ ë Œíƒˆ ê±´ìˆ˜",
                    value=f"{int(new_rental):,}ê±´",
                    delta=f"{delta_pct_new:+.1f}% ({int(delta_new):+,}ê±´)" if prev_new_rental > 0 else "N/A"
                )

            # ì¬ë Œíƒˆ ê±´ìˆ˜
            re_rental = filtered_df['ì¬ë Œíƒˆ(ê±´)'].sum()
            prev_re_rental = prev_month_df['ì¬ë Œíƒˆ(ê±´)'].sum() if not prev_month_df.empty else 0
            delta_re = re_rental - prev_re_rental
            delta_pct_re = (delta_re / prev_re_rental * 100) if prev_re_rental > 0 else 0

            with col3:
                st.metric(
                    label="ì¬ë Œíƒˆ ê±´ìˆ˜",
                    value=f"{int(re_rental):,}ê±´",
                    delta=f"{delta_pct_re:+.1f}% ({int(delta_re):+,}ê±´)" if prev_re_rental > 0 else "N/A"
                )

            # í™ˆì¼€ì–´ ì±„ë„ ë¹„ì¤‘
            homecare_rental = filtered_df[filtered_df['ì˜ì—…ì±„ë„'] == 'í™ˆì¼€ì–´']['ì´ë Œíƒˆ(ê±´)'].sum()
            homecare_ratio = (homecare_rental / total_rental * 100) if total_rental > 0 else 0

            prev_homecare_rental = prev_month_df[prev_month_df['ì˜ì—…ì±„ë„'] == 'í™ˆì¼€ì–´'][
                'ì´ë Œíƒˆ(ê±´)'].sum() if not prev_month_df.empty else 0
            prev_homecare_ratio = (prev_homecare_rental / prev_total_rental * 100) if prev_total_rental > 0 else 0
            delta_homecare = homecare_ratio - prev_homecare_ratio

            with col4:
                st.metric(
                    label="í™ˆì¼€ì–´ ì±„ë„ ë¹„ì¤‘",
                    value=f"{homecare_ratio:.1f}%",
                    delta=f"{delta_homecare:+.1f}%p" if prev_total_rental > 0 else "N/A"
                )

        st.markdown("---")

        # ========== Section 2: ì›”ë³„ ì¶”ì´ ë¶„ì„ ==========
        st.markdown("## ğŸ“Š ì›”ë³„ ì‹¤ì  ì¶”ì´")

        col1, col2 = st.columns(2)

        with col1:
            # ì›”ë³„ ì˜ì—…ì±„ë„ë³„ ì´ë Œíƒˆ ê±´ìˆ˜
            monthly_channel = filtered_df.groupby(['ì›”_ìˆ«ì', 'ì˜ì—…ì±„ë„'], as_index=False)['ì´ë Œíƒˆ(ê±´)'].sum()

            if not monthly_channel.empty:
                # ì›”ë³„ ì „ì²´ í•©ê³„ ê³„ì‚° (ë°±ë¶„ìœ¨ìš©)
                monthly_total = monthly_channel.groupby('ì›”_ìˆ«ì')['ì´ë Œíƒˆ(ê±´)'].sum().reset_index()
                monthly_total.columns = ['ì›”_ìˆ«ì', 'ì›”ë³„í•©ê³„']
                monthly_channel = monthly_channel.merge(monthly_total, on='ì›”_ìˆ«ì')
                monthly_channel['ë¹„ì¤‘(%)'] = (monthly_channel['ì´ë Œíƒˆ(ê±´)'] / monthly_channel['ì›”ë³„í•©ê³„'] * 100).round(1)
                monthly_channel = monthly_channel.sort_values('ì›”_ìˆ«ì')

                fig1 = px.bar(
                    monthly_channel,
                    x='ì›”_ìˆ«ì',
                    y='ì´ë Œíƒˆ(ê±´)',
                    color='ì˜ì—…ì±„ë„',
                    title="ì›”ë³„ ì˜ì—…ì±„ë„ë³„ ì´ë Œíƒˆ ê±´ìˆ˜",
                    labels={'ì›”_ìˆ«ì': 'ì›”', 'ì´ë Œíƒˆ(ê±´)': 'ì´ë Œíƒˆ ê±´ìˆ˜'},
                    text='ì´ë Œíƒˆ(ê±´)',
                    height=400,
                    hover_data={
                        'ì´ë Œíƒˆ(ê±´)': ':,',
                        'ë¹„ì¤‘(%)': ':.1f',
                        'ì›”_ìˆ«ì': False
                    }
                )
                fig1.update_traces(
                    texttemplate='%{text:,.0f}',
                    textposition='inside',
                    hovertemplate='<b>%{fullData.name}</b><br>' +
                                  'ì›”: %{x}ì›”<br>' +
                                  'ì´ë Œíƒˆ: %{y:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                  '<extra></extra>'
                )
                fig1.update_layout(
                    xaxis_type='category',
                    xaxis_title="ì›”",
                    yaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜"
                )
                st.plotly_chart(fig1, use_container_width=True)
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        with col2:
            # ì›”ë³„ ë Œíƒˆ ìœ í˜•ë³„ ê±´ìˆ˜
            monthly_type = filtered_df.groupby('ì›”_ìˆ«ì', as_index=False).agg({
                'ë Œíƒˆ(ê±´)': 'sum',
                'ì¬ë Œíƒˆ(ê±´)': 'sum'
            })

            if not monthly_type.empty:
                monthly_type['ì´ë Œíƒˆ'] = monthly_type['ë Œíƒˆ(ê±´)'] + monthly_type['ì¬ë Œíƒˆ(ê±´)']
                monthly_type['ì‹ ê·œë¹„ì¤‘(%)'] = (monthly_type['ë Œíƒˆ(ê±´)'] / monthly_type['ì´ë Œíƒˆ'] * 100).round(1)
                monthly_type['ì¬ë Œíƒˆë¹„ì¤‘(%)'] = (monthly_type['ì¬ë Œíƒˆ(ê±´)'] / monthly_type['ì´ë Œíƒˆ'] * 100).round(1)
                monthly_type = monthly_type.sort_values('ì›”_ìˆ«ì')

                fig2 = go.Figure()
                fig2.add_trace(go.Bar(
                    x=monthly_type['ì›”_ìˆ«ì'],
                    y=monthly_type['ë Œíƒˆ(ê±´)'],
                    name='ì‹ ê·œ ë Œíƒˆ',
                    text=monthly_type['ë Œíƒˆ(ê±´)'],
                    texttemplate='%{text:,.0f}',
                    textposition='inside',
                    customdata=monthly_type[['ì‹ ê·œë¹„ì¤‘(%)']],
                    hovertemplate='<b>ì‹ ê·œ ë Œíƒˆ</b><br>' +
                                  'ì›”: %{x}ì›”<br>' +
                                  'ê±´ìˆ˜: %{y:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                  '<extra></extra>'
                ))
                fig2.add_trace(go.Bar(
                    x=monthly_type['ì›”_ìˆ«ì'],
                    y=monthly_type['ì¬ë Œíƒˆ(ê±´)'],
                    name='ì¬ë Œíƒˆ',
                    text=monthly_type['ì¬ë Œíƒˆ(ê±´)'],
                    texttemplate='%{text:,.0f}',
                    textposition='inside',
                    customdata=monthly_type[['ì¬ë Œíƒˆë¹„ì¤‘(%)']],
                    hovertemplate='<b>ì¬ë Œíƒˆ</b><br>' +
                                  'ì›”: %{x}ì›”<br>' +
                                  'ê±´ìˆ˜: %{y:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                  '<extra></extra>'
                ))

                fig2.update_layout(
                    title="ì›”ë³„ ë Œíƒˆ ìœ í˜•ë³„ ê±´ìˆ˜ (ì‹ ê·œ vs ì¬ë Œíƒˆ)",
                    xaxis_title="ì›”",
                    yaxis_title="ê±´ìˆ˜",
                    barmode='group',
                    height=400,
                    xaxis_type='category'
                )
                st.plotly_chart(fig2, use_container_width=True)
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        st.markdown("---")

        # ========== Section 3: ì±„ë„ë³„ ì‹¬ì¸µ ë¶„ì„ ==========
        st.markdown("## ğŸ¯ ì˜ì—…ì±„ë„ë³„ ë¶„ì„")

        col1, col2 = st.columns(2)

        with col1:
            # ì˜ì—…ì±„ë„ë³„ ì‹¤ì  ë¹„ì¤‘
            channel_total = filtered_df.groupby('ì˜ì—…ì±„ë„', as_index=False)['ì´ë Œíƒˆ(ê±´)'].sum()

            if not channel_total.empty and channel_total['ì´ë Œíƒˆ(ê±´)'].sum() > 0:
                channel_total['ë¹„ì¤‘(%)'] = (channel_total['ì´ë Œíƒˆ(ê±´)'] / channel_total['ì´ë Œíƒˆ(ê±´)'].sum() * 100).round(1)
                channel_total = channel_total.sort_values('ì´ë Œíƒˆ(ê±´)', ascending=False)

                fig3 = px.pie(
                    channel_total,
                    values='ì´ë Œíƒˆ(ê±´)',
                    names='ì˜ì—…ì±„ë„',
                    title="ì˜ì—…ì±„ë„ë³„ ì‹¤ì  ë¹„ì¤‘",
                    hole=0.4,
                    height=400
                )
                fig3.update_traces(
                    textposition='inside',
                    textinfo='percent+label',
                    hovertemplate='<b>%{label}</b><br>' +
                                  'ê±´ìˆ˜: %{value:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{percent}<br>' +
                                  '<extra></extra>'
                )
                st.plotly_chart(fig3, use_container_width=True)
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        with col2:
            # ì˜ì—…ì±„ë„ë³„ ì„±ì¥ ì¶”ì„¸
            monthly_channel_growth = filtered_df.groupby(['ì›”_ìˆ«ì', 'ì˜ì—…ì±„ë„'], as_index=False)['ì´ë Œíƒˆ(ê±´)'].sum()

            if not monthly_channel_growth.empty:
                # ê° ì±„ë„ë³„ ì›”ë³„ ë¹„ì¤‘ ê³„ì‚°
                monthly_totals = monthly_channel_growth.groupby('ì›”_ìˆ«ì')['ì´ë Œíƒˆ(ê±´)'].sum().reset_index()
                monthly_totals.columns = ['ì›”_ìˆ«ì', 'ì›”ë³„í•©ê³„']
                monthly_channel_growth = monthly_channel_growth.merge(monthly_totals, on='ì›”_ìˆ«ì')
                monthly_channel_growth['ë¹„ì¤‘(%)'] = (
                        monthly_channel_growth['ì´ë Œíƒˆ(ê±´)'] / monthly_channel_growth['ì›”ë³„í•©ê³„'] * 100).round(1)
                monthly_channel_growth = monthly_channel_growth.sort_values('ì›”_ìˆ«ì')

                fig4 = px.line(
                    monthly_channel_growth,
                    x='ì›”_ìˆ«ì',
                    y='ì´ë Œíƒˆ(ê±´)',
                    color='ì˜ì—…ì±„ë„',
                    title="ì˜ì—…ì±„ë„ë³„ ì›”ë³„ ì„±ì¥ ì¶”ì„¸",
                    markers=True,
                    labels={'ì›”_ìˆ«ì': 'ì›”', 'ì´ë Œíƒˆ(ê±´)': 'ì´ë Œíƒˆ ê±´ìˆ˜'},
                    height=400,
                    hover_data={
                        'ì´ë Œíƒˆ(ê±´)': ':,',
                        'ë¹„ì¤‘(%)': ':.1f',
                        'ì›”_ìˆ«ì': False
                    }
                )
                fig4.update_traces(
                    hovertemplate='<b>%{fullData.name}</b><br>' +
                                  'ì›”: %{x}ì›”<br>' +
                                  'ì´ë Œíƒˆ: %{y:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                  '<extra></extra>'
                )
                fig4.update_layout(
                    xaxis_type='category',
                    xaxis_title="ì›”",
                    yaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜"
                )
                st.plotly_chart(fig4, use_container_width=True)
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        st.markdown("---")

        # ========== Section 4: ì œí’ˆ ë¶„ì„ ==========
        st.markdown("## ğŸ† ì œí’ˆë³„ ë¶„ì„")

        col1, col2 = st.columns(2)

        with col1:
            # ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ ë§¤ì¶œ ë¹„ì¤‘
            product1_total = filtered_df.groupby('ì œí’ˆê³„ì¸µêµ¬ì¡°1', as_index=False)['ì´ë Œíƒˆ(ê±´)'].sum()

            if not product1_total.empty and product1_total['ì´ë Œíƒˆ(ê±´)'].sum() > 0:
                product1_total['ë¹„ì¤‘(%)'] = (product1_total['ì´ë Œíƒˆ(ê±´)'] / product1_total['ì´ë Œíƒˆ(ê±´)'].sum() * 100).round(1)
                product1_total = product1_total.sort_values('ì´ë Œíƒˆ(ê±´)', ascending=True)

                fig5 = px.bar(
                    product1_total,
                    x='ì´ë Œíƒˆ(ê±´)',
                    y='ì œí’ˆê³„ì¸µêµ¬ì¡°1',
                    orientation='h',
                    title="ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ ì‹¤ì ",
                    text='ì´ë Œíƒˆ(ê±´)',
                    height=400,
                    hover_data={
                        'ì´ë Œíƒˆ(ê±´)': ':,',
                        'ë¹„ì¤‘(%)': ':.1f'
                    }
                )
                fig5.update_traces(
                    texttemplate='%{text:,.0f}',
                    textposition='outside',
                    hovertemplate='<b>%{y}</b><br>' +
                                  'ê±´ìˆ˜: %{x:,}ê±´<br>' +
                                  'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                  '<extra></extra>'
                )
                fig5.update_layout(
                    xaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜",
                    yaxis_title="ì œí’ˆê³„ì¸µêµ¬ì¡°1"
                )
                st.plotly_chart(fig5, use_container_width=True)
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        with col2:
            # Top 10 ì œí’ˆëª… ì‹¤ì 
            if not filtered_df.empty and filtered_df['ì´ë Œíƒˆ(ê±´)'].sum() > 0:
                top_products = filtered_df.groupby('ì œí’ˆëª…', as_index=False)['ì´ë Œíƒˆ(ê±´)'].sum()
                top_products['ë¹„ì¤‘(%)'] = (top_products['ì´ë Œíƒˆ(ê±´)'] / filtered_df['ì´ë Œíƒˆ(ê±´)'].sum() * 100).round(1)
                top_products = top_products.sort_values('ì´ë Œíƒˆ(ê±´)', ascending=False).head(10)
                top_products = top_products.sort_values('ì´ë Œíƒˆ(ê±´)', ascending=True)

                if not top_products.empty:
                    fig6 = px.bar(
                        top_products,
                        x='ì´ë Œíƒˆ(ê±´)',
                        y='ì œí’ˆëª…',
                        orientation='h',
                        title="Top 10 ì œí’ˆëª… ì‹¤ì ",
                        text='ì´ë Œíƒˆ(ê±´)',
                        height=400,
                        hover_data={
                            'ì´ë Œíƒˆ(ê±´)': ':,',
                            'ë¹„ì¤‘(%)': ':.1f'
                        }
                    )
                    fig6.update_traces(
                        texttemplate='%{text:,.0f}',
                        textposition='outside',
                        hovertemplate='<b>%{y}</b><br>' +
                                      'ê±´ìˆ˜: %{x:,}ê±´<br>' +
                                      'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                      '<extra></extra>'
                    )
                    fig6.update_layout(
                        xaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜",
                        yaxis_title="ì œí’ˆëª…"
                    )
                    st.plotly_chart(fig6, use_container_width=True)
                else:
                    st.warning("ì œí’ˆëª… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        st.markdown("---")

        # ========== Section 5: ì˜ì—…ì±„ë„ë³„ ë Œíƒˆ ìœ í˜• ë¹„ì¤‘ ==========
        st.markdown("## ğŸ”„ ì˜ì—…ì±„ë„ë³„ ë Œíƒˆ ìœ í˜• ë¶„ì„")

        channel_type = filtered_df.groupby('ì˜ì—…ì±„ë„', as_index=False).agg({
            'ì´ë Œíƒˆ(ê±´)': 'sum',
            'ë Œíƒˆ(ê±´)': 'sum',
            'ì¬ë Œíƒˆ(ê±´)': 'sum'
        })

        if not channel_type.empty:
            # 0ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒ ë°©ì§€
            channel_type['ì‹ ê·œë¹„ì¤‘(%)'] = channel_type.apply(
                lambda x: (x['ë Œíƒˆ(ê±´)'] / x['ì´ë Œíƒˆ(ê±´)'] * 100) if x['ì´ë Œíƒˆ(ê±´)'] > 0 else 0,
                axis=1
            ).round(1)
            channel_type['ì¬ë Œíƒˆë¹„ì¤‘(%)'] = channel_type.apply(
                lambda x: (x['ì¬ë Œíƒˆ(ê±´)'] / x['ì´ë Œíƒˆ(ê±´)'] * 100) if x['ì´ë Œíƒˆ(ê±´)'] > 0 else 0,
                axis=1
            ).round(1)

            fig7 = go.Figure()
            fig7.add_trace(go.Bar(
                y=channel_type['ì˜ì—…ì±„ë„'],
                x=channel_type['ë Œíƒˆ(ê±´)'],
                name='ì‹ ê·œ ë Œíƒˆ',
                orientation='h',
                text=channel_type['ë Œíƒˆ(ê±´)'],
                texttemplate='%{text:,.0f}',
                textposition='inside',
                customdata=channel_type[['ì‹ ê·œë¹„ì¤‘(%)']],
                hovertemplate='<b>ì‹ ê·œ ë Œíƒˆ</b><br>' +
                              'ì±„ë„: %{y}<br>' +
                              'ê±´ìˆ˜: %{x:,}ê±´<br>' +
                              'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                              '<extra></extra>'
            ))
            fig7.add_trace(go.Bar(
                y=channel_type['ì˜ì—…ì±„ë„'],
                x=channel_type['ì¬ë Œíƒˆ(ê±´)'],
                name='ì¬ë Œíƒˆ',
                orientation='h',
                text=channel_type['ì¬ë Œíƒˆ(ê±´)'],
                texttemplate='%{text:,.0f}',
                textposition='inside',
                customdata=channel_type[['ì¬ë Œíƒˆë¹„ì¤‘(%)']],
                hovertemplate='<b>ì¬ë Œíƒˆ</b><br>' +
                              'ì±„ë„: %{y}<br>' +
                              'ê±´ìˆ˜: %{x:,}ê±´<br>' +
                              'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                              '<extra></extra>'
            ))

            fig7.update_layout(
                title="ì˜ì—…ì±„ë„ë³„ ë Œíƒˆ ìœ í˜• ë¹„ì¤‘ (ì‹ ê·œ vs ì¬ë Œíƒˆ)",
                xaxis_title="ê±´ìˆ˜",
                yaxis_title="ì˜ì—…ì±„ë„",
                barmode='stack',
                height=400
            )
            st.plotly_chart(fig7, use_container_width=True)
        else:
            st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        st.markdown("---")

    except Exception as e:
        st.error(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        import traceback

        st.code(traceback.format_exc())
else:
    st.info("ğŸ‘† íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.")

    # ========== Section 6: ìƒì„¸ ë°ì´í„° í…Œì´ë¸” ==========
    st.markdown("## ğŸ“‹ ìƒì„¸ ë°ì´í„°")

    if not filtered_df.empty:
        # í‘œì‹œí•  ì»¬ëŸ¼ ì„ íƒ
        display_columns = ['ì—°ë„', 'ì›”', 'ì˜ì—…ì±„ë„', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1', 'ì œí’ˆê³„ì¸µêµ¬ì¡°2',
                           'ì œí’ˆëª…', 'ì´ë Œíƒˆ(ê±´)', 'ë Œíƒˆ(ê±´)', 'ì¬ë Œíƒˆ(ê±´)']

        # ì›” ì»¬ëŸ¼ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (í‘œì‹œìš©)
        filtered_df_display = filtered_df.copy()
        filtered_df_display['ì›”'] = filtered_df_display['ì›”_ìˆ«ì'].astype(str) + 'ì›”'

        # ë¨¼ì € ì •ë ¬í•œ í›„ ì»¬ëŸ¼ ì„ íƒ
        filtered_df_sorted = filtered_df_display.sort_values(['ì›”_ìˆ«ì', 'ì´ë Œíƒˆ(ê±´)'], ascending=[True, False])

        st.dataframe(
            filtered_df_sorted[display_columns],
            use_container_width=True,
            height=400
        )

        # CSV ë‹¤ìš´ë¡œë“œ
        csv = filtered_df_sorted[display_columns].to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="ğŸ“¥ í•„í„°ë§ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (CSV)",
            data=csv,
            file_name=f"ì˜ì—…ì‹¤ì _í•„í„°ë§_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )

        # ë°ì´í„° ìš”ì•½ ì •ë³´ (ì•ˆì „í•œ ë³€ìˆ˜ ê³„ì‚°)
        total_rental_sum = filtered_df['ì´ë Œíƒˆ(ê±´)'].sum()
        new_rental_sum = filtered_df['ë Œíƒˆ(ê±´)'].sum()
        re_rental_sum = filtered_df['ì¬ë Œíƒˆ(ê±´)'].sum()

        st.info(
            f"ğŸ“Š í•„í„°ë§ëœ ë°ì´í„°: ì´ {len(filtered_df):,}ê±´ | ì´ ë Œíƒˆ: {int(total_rental_sum):,}ê±´ | ì‹ ê·œ: {int(new_rental_sum):,}ê±´ | ì¬ë Œíƒˆ: {int(re_rental_sum):,}ê±´")
    else:
        st.warning("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    st.markdown("---")

    # ========== Section 7, 8: íŒŒì¼2 ë¶„ì„ (ì•½ì •ê¸°ê°„ë³„) ==========
    if uploaded_file2 is not None:
        st.markdown("## ğŸ“… ì•½ì •ê¸°ê°„ë³„ ë¶„ì„ (íŒŒì¼2)")

        try:
            # íŒŒì¼2 ë¡œë“œ
            if uploaded_file2.name.endswith('.csv'):
                df2 = pd.read_csv(uploaded_file2, encoding='utf-8-sig')
            else:
                df2 = pd.read_excel(uploaded_file2)

            # ì»¬ëŸ¼ëª… ì •ë¦¬
            df2.columns = df2.columns.str.strip()

            st.write(f"ğŸ“ íŒŒì¼2 ë¡œë“œ ì„±ê³µ: {len(df2)}í–‰ Ã— {len(df2.columns)}ì—´")
            st.write("ğŸ” **íŒŒì¼2 ì»¬ëŸ¼:**", df2.columns.tolist()[:10])


            # íŒŒì¼2 ì „ì²˜ë¦¬
            def preprocess_file2(df):
                """íŒŒì¼2 ë°ì´í„° ì „ì²˜ë¦¬ í•¨ìˆ˜"""
                df = df.copy()

                # ì—°ë„ ì²˜ë¦¬
                if 'ì—°ë„' in df.columns:
                    df['ì—°ë„'] = df['ì—°ë„'].astype(str).str.replace('ë…„', '').str.strip()
                    df['ì—°ë„'] = pd.to_numeric(df['ì—°ë„'], errors='coerce')
                    df = df.dropna(subset=['ì—°ë„'])
                    df['ì—°ë„'] = df['ì—°ë„'].astype(int)

                # ì›” ì²˜ë¦¬
                if 'ì›”' in df.columns:
                    df['ì›”'] = df['ì›”'].astype(str).str.replace('ì›”', '').str.strip()
                    df['ì›”_ìˆ«ì'] = pd.to_numeric(df['ì›”'], errors='coerce')
                    df = df.dropna(subset=['ì›”_ìˆ«ì'])
                    df['ì›”_ìˆ«ì'] = df['ì›”_ìˆ«ì'].astype(int)

                # ì´ë Œíƒˆ(ê±´) ì²˜ë¦¬
                rental_cols = [col for col in df.columns if 'ì´ë Œíƒˆ' in col and 'ê±´' in col]
                if rental_cols:
                    df['ì´ë Œíƒˆ(ê±´)'] = pd.to_numeric(df[rental_cols[0]], errors='coerce').fillna(0)

                # ì•½ì •ê¸°ê°„ ì²˜ë¦¬
                contract_cols = [col for col in df.columns if 'ì•½ì •' in col and 'ê¸°ê°„' in col]
                if contract_cols:
                    df['ì•½ì •ê¸°ê°„'] = df[contract_cols[0]].astype(str).str.strip()

                # ë¦¬ìŠ¤êµ¬ë¶„ ì²˜ë¦¬
                lease_cols = [col for col in df.columns if 'ë¦¬ìŠ¤' in col and 'êµ¬ë¶„' in col]
                if lease_cols:
                    df['ë¦¬ìŠ¤êµ¬ë¶„'] = df[lease_cols[0]].astype(str).str.strip()

                # ì œí’ˆê³„ì¸µêµ¬ì¡°1 ì²˜ë¦¬
                product1_cols = [col for col in df.columns if 'ì œí’ˆê³„ì¸µêµ¬ì¡°1' in col or 'ì œí’ˆê³„ì¸µêµ¬ì¡° 1' in col]
                if product1_cols:
                    df['ì œí’ˆê³„ì¸µêµ¬ì¡°1'] = df[product1_cols[0]].astype(str).str.strip()

                # ì œí’ˆëª… ì²˜ë¦¬ (ìˆëŠ” ê²½ìš°)
                product_name_cols = [col for col in df.columns if 'ì œí’ˆëª…' in col]
                if product_name_cols:
                    df['ì œí’ˆëª…'] = df[product_name_cols[0]].astype(str).str.strip()

                # NaN ì œê±°
                df = df.dropna(subset=['ì—°ë„', 'ì›”_ìˆ«ì'])

                return df


            df2 = preprocess_file2(df2)

            # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
            required_cols_2 = ['ì—°ë„', 'ì›”_ìˆ«ì', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1', 'ì´ë Œíƒˆ(ê±´)']
            missing_cols = [col for col in required_cols_2 if col not in df2.columns]

            if missing_cols:
                st.error(f"íŒŒì¼2ì— í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: {', '.join(missing_cols)}")
                st.info(f"í˜„ì¬ íŒŒì¼2ì˜ ì»¬ëŸ¼: {', '.join(df2.columns.tolist())}")
            else:
                # ì•½ì •ê¸°ê°„ê³¼ ë¦¬ìŠ¤êµ¬ë¶„ì´ ìˆëŠ”ì§€ í™•ì¸
                has_contract = 'ì•½ì •ê¸°ê°„' in df2.columns
                has_lease = 'ë¦¬ìŠ¤êµ¬ë¶„' in df2.columns

                if not has_contract:
                    st.warning("âš ï¸ 'ì•½ì •ê¸°ê°„' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

                # ì‚¬ì´ë“œë°” í•„í„° ì¶”ê°€ (íŒŒì¼2ìš©)
                st.sidebar.markdown("---")
                st.sidebar.header("ğŸ” íŒŒì¼2 í•„í„° ì„¤ì •")

                # ì—°ë„ í•„í„°
                years_2 = sorted(df2['ì—°ë„'].unique())
                if len(years_2) > 0:
                    selected_year_2 = st.sidebar.selectbox("íŒŒì¼2 ì—°ë„ ì„ íƒ", years_2, index=len(years_2) - 1, key="year2")
                else:
                    st.error("íŒŒì¼2ì— ì—°ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    selected_year_2 = None

                if selected_year_2:
                    # ì›” í•„í„°
                    months_2 = sorted(df2[df2['ì—°ë„'] == selected_year_2]['ì›”_ìˆ«ì'].unique())
                    if len(months_2) > 0:
                        selected_months_2 = st.sidebar.multiselect(
                            "íŒŒì¼2 ì›” ì„ íƒ",
                            months_2,
                            default=months_2,
                            key="months2"
                        )
                    else:
                        st.error(f"íŒŒì¼2ì— {selected_year_2}ë…„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                        selected_months_2 = []

                    # ì œí’ˆê³„ì¸µêµ¬ì¡°1 í•„í„°
                    product1_2 = sorted(df2['ì œí’ˆê³„ì¸µêµ¬ì¡°1'].dropna().unique())
                    selected_product1_2 = st.sidebar.multiselect(
                        "íŒŒì¼2 ì œí’ˆê³„ì¸µêµ¬ì¡°1 ì„ íƒ",
                        product1_2,
                        default=product1_2,
                        key="product1_2"
                    )

                    # ì œí’ˆëª… í•„í„° (Section 8ìš©)
                    if 'ì œí’ˆëª…' in df2.columns:
                        products_2 = sorted(df2['ì œí’ˆëª…'].dropna().unique())
                        selected_products_2 = st.sidebar.multiselect(
                            "íŒŒì¼2 ì œí’ˆëª… ê²€ìƒ‰ (Section 8ìš©)",
                            products_2,
                            key="products2"
                        )
                    else:
                        selected_products_2 = []

                    # ë°ì´í„° í•„í„°ë§
                    filtered_df2 = df2[
                        (df2['ì—°ë„'] == selected_year_2) &
                        (df2['ì›”_ìˆ«ì'].isin(selected_months_2)) &
                        (df2['ì œí’ˆê³„ì¸µêµ¬ì¡°1'].isin(selected_product1_2))
                        ].copy()

                    if len(filtered_df2) == 0:
                        st.warning("ì„ íƒí•œ í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    elif not has_contract:
                        st.warning("ì•½ì •ê¸°ê°„ ì»¬ëŸ¼ì´ ì—†ì–´ Section 7, 8ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    else:
                        # Section 7: ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ Ã— ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´
                        st.markdown("### ğŸ“Š Section 7: ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ Ã— ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´")

                        # ì•½ì •ê¸°ê°„ë³„ë¡œ ìƒ‰ìƒ êµ¬ë¶„í•˜ì—¬ ëˆ„ì  ë§‰ëŒ€ ì°¨íŠ¸
                        chart_data_7 = filtered_df2.groupby(
                            ['ì›”_ìˆ«ì', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1', 'ì•½ì •ê¸°ê°„'],
                            as_index=False
                        )['ì´ë Œíƒˆ(ê±´)'].sum()

                        if not chart_data_7.empty:
                            # ê° ì›”/ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ ì´í•© ê³„ì‚° (ë°±ë¶„ìœ¨ìš©)
                            monthly_product_total = chart_data_7.groupby(['ì›”_ìˆ«ì', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1'])[
                                'ì´ë Œíƒˆ(ê±´)'].sum().reset_index()
                            monthly_product_total.columns = ['ì›”_ìˆ«ì', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1', 'ì›”ë³„ì œí’ˆí•©ê³„']
                            chart_data_7 = chart_data_7.merge(monthly_product_total, on=['ì›”_ìˆ«ì', 'ì œí’ˆê³„ì¸µêµ¬ì¡°1'])
                            chart_data_7['ë¹„ì¤‘(%)'] = chart_data_7.apply(
                                lambda x: (x['ì´ë Œíƒˆ(ê±´)'] / x['ì›”ë³„ì œí’ˆí•©ê³„'] * 100) if x['ì›”ë³„ì œí’ˆí•©ê³„'] > 0 else 0,
                                axis=1
                            ).round(1)

                            # ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ë¡œ ì„œë¸Œí”Œë¡¯ ìƒì„±
                            for product1 in selected_product1_2:
                                product_data = chart_data_7[chart_data_7['ì œí’ˆê³„ì¸µêµ¬ì¡°1'] == product1].copy()

                                if not product_data.empty:
                                    fig7 = px.bar(
                                        product_data,
                                        x='ì›”_ìˆ«ì',
                                        y='ì´ë Œíƒˆ(ê±´)',
                                        color='ì•½ì •ê¸°ê°„',
                                        title=f"{product1} - ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´",
                                        labels={'ì›”_ìˆ«ì': 'ì›”', 'ì´ë Œíƒˆ(ê±´)': 'ì´ë Œíƒˆ ê±´ìˆ˜', 'ì•½ì •ê¸°ê°„': 'ì•½ì •ê¸°ê°„'},
                                        text='ì´ë Œíƒˆ(ê±´)',
                                        height=450,
                                        hover_data={
                                            'ì´ë Œíƒˆ(ê±´)': ':,',
                                            'ë¹„ì¤‘(%)': ':.1f',
                                            'ì›”_ìˆ«ì': False
                                        }
                                    )

                                    fig7.update_traces(
                                        texttemplate='%{text:,.0f}',
                                        textposition='inside',
                                        hovertemplate='<b>ì•½ì •ê¸°ê°„: %{fullData.name}</b><br>' +
                                                      'ì›”: %{x}ì›”<br>' +
                                                      'ì´ë Œíƒˆ: %{y:,}ê±´<br>' +
                                                      'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                                      '<extra></extra>'
                                    )

                                    fig7.update_layout(
                                        xaxis_type='category',
                                        xaxis_title="ì›”",
                                        yaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜",
                                        barmode='stack'
                                    )

                                    st.plotly_chart(fig7, use_container_width=True)
                        else:
                            st.warning("ì°¨íŠ¸ë¥¼ ìƒì„±í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

                        st.markdown("---")

                        # Section 8: ì œí’ˆëª… ê²€ìƒ‰ â†’ ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´
                        if selected_products_2 and 'ì œí’ˆëª…' in filtered_df2.columns:
                            st.markdown("### ğŸ” Section 8: ì œí’ˆëª…ë³„ Ã— ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´")

                            # ì„ íƒëœ ì œí’ˆëª… í•„í„°ë§
                            product_filtered_df2 = filtered_df2[
                                filtered_df2['ì œí’ˆëª…'].isin(selected_products_2)
                            ].copy()

                            if len(product_filtered_df2) == 0:
                                st.warning("ì„ íƒí•œ ì œí’ˆëª…ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                            else:
                                chart_data_8 = product_filtered_df2.groupby(
                                    ['ì›”_ìˆ«ì', 'ì œí’ˆëª…', 'ì•½ì •ê¸°ê°„'],
                                    as_index=False
                                )['ì´ë Œíƒˆ(ê±´)'].sum()

                                if not chart_data_8.empty:
                                    # ê° ì›”/ì œí’ˆëª…ë³„ ì´í•© ê³„ì‚° (ë°±ë¶„ìœ¨ìš©)
                                    monthly_product_name_total = chart_data_8.groupby(['ì›”_ìˆ«ì', 'ì œí’ˆëª…'])[
                                        'ì´ë Œíƒˆ(ê±´)'].sum().reset_index()
                                    monthly_product_name_total.columns = ['ì›”_ìˆ«ì', 'ì œí’ˆëª…', 'ì›”ë³„ì œí’ˆëª…í•©ê³„']
                                    chart_data_8 = chart_data_8.merge(monthly_product_name_total, on=['ì›”_ìˆ«ì', 'ì œí’ˆëª…'])
                                    chart_data_8['ë¹„ì¤‘(%)'] = chart_data_8.apply(
                                        lambda x: (x['ì´ë Œíƒˆ(ê±´)'] / x['ì›”ë³„ì œí’ˆëª…í•©ê³„'] * 100) if x['ì›”ë³„ì œí’ˆëª…í•©ê³„'] > 0 else 0,
                                        axis=1
                                    ).round(1)

                                    # ì œí’ˆëª…ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
                                    for product_name in selected_products_2:
                                        product_name_data = chart_data_8[chart_data_8['ì œí’ˆëª…'] == product_name].copy()

                                        if not product_name_data.empty:
                                            fig8 = px.bar(
                                                product_name_data,
                                                x='ì›”_ìˆ«ì',
                                                y='ì´ë Œíƒˆ(ê±´)',
                                                color='ì•½ì •ê¸°ê°„',
                                                title=f"{product_name} - ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´",
                                                labels={'ì›”_ìˆ«ì': 'ì›”', 'ì´ë Œíƒˆ(ê±´)': 'ì´ë Œíƒˆ ê±´ìˆ˜', 'ì•½ì •ê¸°ê°„': 'ì•½ì •ê¸°ê°„'},
                                                text='ì´ë Œíƒˆ(ê±´)',
                                                height=450,
                                                hover_data={
                                                    'ì´ë Œíƒˆ(ê±´)': ':,',
                                                    'ë¹„ì¤‘(%)': ':.1f',
                                                    'ì›”_ìˆ«ì': False
                                                }
                                            )

                                        fig8.update_traces(
                                            texttemplate='%{text:,.0f}',
                                            textposition='inside',
                                            hovertemplate='<b>ì•½ì •ê¸°ê°„: %{fullData.name}</b><br>' +
                                                          'ì›”: %{x}ì›”<br>' +
                                                          'ì´ë Œíƒˆ: %{y:,}ê±´<br>' +
                                                          'ë¹„ì¤‘: %{customdata[0]:.1f}%<br>' +
                                                          '<extra></extra>'
                                        )

                                        fig8.update_layout(
                                            xaxis_type='category',
                                            xaxis_title="ì›”",
                                            yaxis_title="ì´ë Œíƒˆ ê±´ìˆ˜",
                                            barmode='stack'
                                        )

                                        st.plotly_chart(fig8, use_container_width=True)
                                else:
                                    st.warning("ì°¨íŠ¸ë¥¼ ìƒì„±í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                        elif not selected_products_2:
                            st.info("ğŸ’¡ ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ 'íŒŒì¼2 ì œí’ˆëª… ê²€ìƒ‰'ì„ ì„ íƒí•˜ë©´ Section 8ì´ í‘œì‹œë©ë‹ˆë‹¤.")

        except Exception as e:
            st.error(f"íŒŒì¼2 ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
            import traceback

            st.code(traceback.format_exc())

    except Exception as e:
    st.error(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
    import traceback

    st.code(traceback.format_exc())

else:
st.info("ğŸ‘† íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.")

# ì•ˆë‚´ ë©”ì‹œì§€
st.markdown("""
    ### ğŸ“– ì‚¬ìš© ë°©ë²•
    1. **íŒŒì¼ ì—…ë¡œë“œ**: 
       - íŒŒì¼1 (í•„ìˆ˜): ì˜ì—…ì±„ë„ ì¤‘ì‹¬ ë¶„ì„ìš© ì—‘ì…€/CSV
       - íŒŒì¼2 (ì„ íƒ): ì•½ì •ê¸°ê°„/ë¦¬ìŠ¤êµ¬ë¶„ ì¤‘ì‹¬ ë¶„ì„ìš© ì—‘ì…€/CSV
    2. **í•„í„° ì„¤ì •**: ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ ì›í•˜ëŠ” ì¡°ê±´ì„ ì„ íƒí•©ë‹ˆë‹¤.
    3. **ëŒ€ì‹œë³´ë“œ í™•ì¸**: ë‹¤ì–‘í•œ ì°¨íŠ¸ì™€ KPIë¥¼ í†µí•´ ì‹¤ì ì„ ë¶„ì„í•©ë‹ˆë‹¤.
    
    ### ğŸ“Š ì œê³µë˜ëŠ” ë¶„ì„
    **[íŒŒì¼1 ë¶„ì„]**
    - **í•µì‹¬ KPI**: ì´ë Œíƒˆ, ì‹ ê·œë Œíƒˆ, ì¬ë Œíƒˆ ê±´ìˆ˜ ë° í™ˆì¼€ì–´ ì±„ë„ ë¹„ì¤‘
    - **ì›”ë³„ ì¶”ì´**: ì˜ì—…ì±„ë„ë³„/ìœ í˜•ë³„ ì›”ê°„ ì‹¤ì  ë³€í™”
    - **ì±„ë„ ë¶„ì„**: ì˜ì—…ì±„ë„ë³„ ë¹„ì¤‘ ë° ì„±ì¥ ì¶”ì„¸
    - **ì œí’ˆ ë¶„ì„**: ì œí’ˆê³„ì¸µêµ¬ì¡°ë³„ ë° Top 10 ì œí’ˆ ì‹¤ì 
    - **ìœ í˜• ë¶„ì„**: ì˜ì—…ì±„ë„ë³„ ì‹ ê·œ/ì¬ë Œíƒˆ ë¹„ì¤‘
    - **ìƒì„¸ ë°ì´í„°**: í•„í„°ë§ëœ ì „ì²´ ë°ì´í„° ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ
    
    **[íŒŒì¼2 ë¶„ì„] (íŒŒì¼2 ì—…ë¡œë“œ ì‹œ)**
    - **Section 7**: ì œí’ˆê³„ì¸µêµ¬ì¡°1ë³„ Ã— ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´
    - **Section 8**: ì œí’ˆëª…ë³„ Ã— ì•½ì •ê¸°ê°„ë³„ ì›”ë³„ ì¶”ì´
    """)
